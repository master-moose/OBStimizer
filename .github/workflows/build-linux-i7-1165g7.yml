name: Build OBS with Rust Optimizations - Linux (i7-1165G7)

on:
  push:
    branches: [ main, rust-optimization-* ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  OBS_VERSION: '30.0.0'
  
jobs:
  build-linux-i7-1165g7:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout OBS Studio
      uses: actions/checkout@v4
      with:
        submodules: recursive
        
    - name: Setup Rust toolchain
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: x86_64-unknown-linux-gnu
        
    - name: Install Rust build dependencies
      run: |
        rustup component add rustfmt clippy
        cargo install cbindgen
        
    - name: Cache Rust dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/bin/
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
          rust-core/target/
        key: ${{ runner.os }}-cargo-i7-1165g7-${{ hashFiles('**/Cargo.lock') }}
        
    - name: Install OBS build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          git \
          libavcodec-dev \
          libavdevice-dev \
          libavfilter-dev \
          libavformat-dev \
          libavutil-dev \
          libswresample-dev \
          libswscale-dev \
          libx264-dev \
          libcurl4-openssl-dev \
          libmbedtls-dev \
          libgl1-mesa-dev \
          libjansson-dev \
          libluajit-5.1-dev \
          libpython3-dev \
          libx11-dev \
          libxcb-randr0-dev \
          libxcb-shm0-dev \
          libxcb-xinerama0-dev \
          libxcb-composite0-dev \
          libxcb1-dev \
          libxcomposite-dev \
          libxinerama-dev \
          pkg-config \
          python3-dev \
          qtbase5-dev \
          libqt5svg5-dev \
          swig \
          libwayland-dev \
          libpipewire-0.3-dev \
          libdrm-dev \
          ninja-build
        
    - name: Build Rust libraries (i7-1165G7 profile)
      run: |
        export RUSTFLAGS="-C target-cpu=tigerlake -C target-feature=+avx2,+avx512f,+avx512dq -C opt-level=3"
        cd rust-core
        cargo build --release --workspace
        
    - name: Generate C headers
      run: |
        cd rust-core/obs-ffi
        cbindgen --config cbindgen.toml --crate obs-ffi --output obs-rust.h
        
    - name: Configure CMake
      run: |
        cmake -B build -S . \
          -DCMAKE_BUILD_TYPE=Release \
          -DOBS_CMAKE_VERSION=3.0.0 \
          -DENABLE_RUST_OPTIMIZATIONS=ON \
          -DRUST_TARGET_CPU=tigerlake \
          -GNinja
          
    - name: Build OBS Studio
      run: cmake --build build --config Release --parallel
      
    - name: Package OBS
      run: |
        cmake --install build --prefix install
        cd install
        tar -czf ../obs-studio-rust-i7-1165g7-linux.tar.gz *
        
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: obs-studio-i7-1165g7-linux
        path: obs-studio-rust-i7-1165g7-linux.tar.gz
        
    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: obs-studio-rust-i7-1165g7-linux.tar.gz
        body: |
          ## OBS Studio with Rust Optimizations
          
          **Hardware Target:** Intel i7-1165G7 (Laptop)
          
          **Optimizations:**
          - AVX2 + AVX-512 optimized video format conversion
          - Lock-free scene compositor
          - SIMD-accelerated transform calculations
          - Tiger Lake CPU optimizations
          
          **Expected Performance:**
          - 20-30% CPU usage reduction
          - 15-25% encoding latency improvement
          - Better thermal efficiency on laptop
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
