name: Build OBS with Rust Optimizations - Windows (i7-9700K)

on:
  push:
    branches: [ main, rust-optimization-* ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  OBS_VERSION: '30.0.0'
  
jobs:
  build-windows-i7-9700k:
    runs-on: windows-latest
    
    steps:
    - name: Checkout OBS Studio
      uses: actions/checkout@v4
      with:
        submodules: recursive
        
    - name: Setup Rust toolchain
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: x86_64-pc-windows-msvc
        
    - name: Install Rust build dependencies
      run: |
        rustup component add rustfmt clippy
        cargo install cbindgen
        
    - name: Cache Rust dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/bin/
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
          rust-core/target/
        key: ${{ runner.os }}-cargo-i7-9700k-${{ hashFiles('**/Cargo.lock') }}
        
    - name: Build Rust libraries (i7-9700K profile)
      shell: pwsh
      run: |
        $env:RUSTFLAGS = "-C target-cpu=skylake -C target-feature=+avx2,+fma -C opt-level=3"
        cd rust-core
        cargo build --release --workspace
        
    - name: Generate C headers
      shell: pwsh
      run: |
        cd rust-core/obs-ffi
        cbindgen --config cbindgen.toml --crate obs-ffi --output obs-rust.h
        
    - name: Setup MSVC
      uses: ilammy/msvc-dev-cmd@v1
      
    - name: Install Qt
      uses: jurplel/install-qt-action@v3
      with:
        version: '6.6.0'
        arch: 'win64_msvc2019_64'
        
    - name: Configure CMake
      run: |
        cmake -B build -S . `
          -DCMAKE_BUILD_TYPE=Release `
          -DOBS_CMAKE_VERSION=3.0.0 `
          -DENABLE_RUST_OPTIMIZATIONS=ON `
          -DRUST_TARGET_CPU=skylake `
          -G "Visual Studio 17 2022" -A x64
          
    - name: Build OBS Studio
      run: cmake --build build --config Release --parallel
      
    - name: Package OBS
      run: |
        cmake --install build --prefix install --config Release
        cd install
        7z a ../obs-studio-rust-i7-9700k-windows.zip *
        
    - name: Upload artifact
      uses: actions/upload-artifact@v3
      with:
        name: obs-studio-i7-9700k-windows
        path: obs-studio-rust-i7-9700k-windows.zip
        
    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: obs-studio-rust-i7-9700k-windows.zip
        body: |
          ## OBS Studio with Rust Optimizations
          
          **Hardware Target:** Intel i7-9700K + RTX 3050 (Desktop PC)
          
          **Optimizations:**
          - AVX2-optimized video format conversion
          - Lock-free scene compositor
          - SIMD-accelerated transform calculations
          - RTX 3050 NVENC support
          
          **Expected Performance:**
          - 20-30% CPU usage reduction
          - 15-25% encoding latency improvement
          - Better multi-encoder scaling
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
